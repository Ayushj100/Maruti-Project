/* eslint-disable no-restricted-globals */
import {
  loadHeader,
  loadFooter,
  decorateButtons,
  decorateIcons,
  decorateSections,
  decorateBlocks,
  decorateTemplateAndTheme,
  waitForLCP,
  loadBlocks,
  loadCSS,
  wrapTextNodes,
  buildBlock,
  updateSectionsStatus,
  fetchPlaceholders,
  getMetadata,
  decorateBlock,
  loadBlock,
} from './aem.js';
import { martechLoadedPromise, martechEager, martechLazy, martechDelayed } from './martech-loader.js';
import { utility, seoUtils, authUtils } from '../utility/masterUtil.js';

export const LCP_BLOCKS = [...(window.hlx?.lcpBlocks || [])]; // add your common LCP blocks to the list
const DELIVERY_ASSET_IDENTIFIER = '/adobe/assets/urn:aaid:aem:';
const DELIVERY_VIDEO_IDENTIFIER = '/play';
const DELIVERY_IMAGE_IDENTIFIER = '/as/';
const LOAD_MARTECH_PARAM = 'loadMartech';
let siteDomain = null;

const pageUrl = new URL(window.location.href);
const hidValue = pageUrl.searchParams.get("hid");

/**
 * Moves all the attributes from a given elmenet to another given element.
 * @param {Element} from the element to copy attributes from
 * @param {Element} to the element to copy attributes to
 */
export function moveAttributes(from, to, attributes) {
  if (!attributes) {
    // eslint-disable-next-line no-param-reassign
    attributes = [...from.attributes].map(({ nodeName }) => nodeName);
  }
  attributes.forEach((attr) => {
    const value = from.getAttribute(attr);
    if (value) {
      to.setAttribute(attr, value);
      from.removeAttribute(attr);
    }
  });
}

/**
 * Move instrumentation attributes from a given element to another given element.
 * @param {Element} from the element to copy attributes from
 * @param {Element} to the element to copy attributes to
 */
export function moveInstrumentation(from, to) {
  moveAttributes(
    from,
    to,
    [...from.attributes]
      .map(({ nodeName }) => nodeName)
      .filter((attr) => attr.startsWith('data-aue-') || attr.startsWith('data-richtext-')),
  );
}

/**
 * load fonts.css and set a session storage flag
 */
async function loadFonts() {
  await loadCSS(`${window.hlx.codeBasePath}/styles/fonts.css`);
  try {
    if (!window.location.hostname.includes('localhost')) sessionStorage.setItem('fonts-loaded', 'true');
  } catch (e) {
    // do nothing
  }
}

function buildMultiStepForms(main) {
  const multiStepForms = ['sf-journey-start', 'loan-application', 'ebook-journey'];
  multiStepForms.forEach((form) => {
    const formStepClassName = `${form}-step`;
    const formStepSelector = `.${formStepClassName}`;
    // multi-step forms are sections that have a least one step
    main.querySelectorAll(`:scope > div:not([data-section-status]):has(${formStepSelector})`).forEach((formSection) => {
      const firstStep = formSection.querySelector(formStepSelector);
      const previousElement = firstStep.previousElementSibling;
      // wrap all consecutive steps in a new block
      const steps = [];
      let step = firstStep;
      do {
        step.classList.remove(formStepClassName);
        wrapTextNodes(step);
        steps.push([step]);
        step = step.nextElementSibling;
      } while (step?.matches(formStepSelector));
      // remove any remaining out-of-order steps
      formSection.querySelectorAll(formStepSelector).forEach((s) => s.remove());
      // create a new block and replace the first step with it
      const block = buildBlock(form, steps);
      if (previousElement) previousElement.after(block);
      else formSection.prepend(block);
    });
  });
}

/**
 * Builds all synthetic blocks in a container element.
 * @param {Element} main The container element
 */
export function buildAutoBlocks(main) {
  try {
    buildMultiStepForms(main);
  } catch (error) {
    // eslint-disable-next-line no-console
    console.error('Auto Blocking failed', error);
  }
}

// if the link passed is relative, this will return false
function isExternalLink(url) {
  const parsedUrl = new URL(url, window.location.href);
  return parsedUrl.origin !== window.location.origin;
}

/**
 * Returns a picture element with webp and fallbacks
 * @param {string} src The image URL
 * @param {string} [alt] The image alternative text
 * @param {boolean} [eager] Set loading attribute to eager
 * @param {Array} [breakpoints] Breakpoints and corresponding params (eg. width)
 * @returns {Element} The picture element
 */
function createOptimizedPictureWithDeliveryUrls(
  src,
  alt = '',
  eager = false,
  breakpoints = [{ media: '(min-width: 600px)', width: '2000' }, { width: '750' }],
) {
  const dmUrl = new URL(src, window.location.href);
  const width = dmUrl.searchParams.get('width');
  const height = dmUrl.searchParams.get('height');
  const picture = document.createElement('picture');

  breakpoints.forEach((br, i) => {
    const currentExtension = dmUrl.pathname.substring(dmUrl.pathname.lastIndexOf('.') + 1);
    if (currentExtension.toLowerCase() !== 'svg' && currentExtension.toLowerCase() !== 'gif') {
      if (currentExtension.toLowerCase() !== 'jpg' && currentExtension.toLowerCase() !== 'jpeg') {
        dmUrl.href = `${dmUrl.href.substring(0, dmUrl.href.lastIndexOf('.'))}.png`;
      }
      dmUrl.searchParams.set('width', br.width);
      // DM open api smart imaging
      dmUrl.searchParams.set('id', '1');
      dmUrl.searchParams.set('preferwebp', 'true');
      if (i < breakpoints.length - 1) {
        const source = document.createElement('source');
        if (br.media) source.setAttribute('media', br.media);
        source.setAttribute('srcset', dmUrl.href);
        if (height) {
          source.setAttribute('height', height);
        }
        if (width) {
          source.setAttribute('width', width);
        }
        picture.appendChild(source);
      }
    }
  });

  // Create the img element
  const img = document.createElement('img');
  img.setAttribute('loading', eager ? 'eager' : 'lazy');
  img.setAttribute('alt', alt);
  img.setAttribute('src', dmUrl.href);
  if (height) {
    img.setAttribute('height', height);
  }
  if (width) {
    img.setAttribute('width', width);
  }
  picture.appendChild(img);

  return picture;
}

export function getSiteDomain() {
  if (siteDomain === null) {
    const currUrl = window.location.href;
    if (
      currUrl.includes('localhost') ||
      currUrl.includes('aem.live') ||
      currUrl.includes('aem.page') ||
      currUrl.includes('author')
    ) {
      siteDomain = getMetadata('site-domain');
    }
    if (!siteDomain) {
      siteDomain = window.location.origin;
    }
  }
  return siteDomain;
}

function loadLcpImagesEarly(main) {
  const imgLoader = (src) => {
    if (!src) return null;
    const lcpImgLoadEarly = new Image();
    lcpImgLoadEarly.src = src;
    lcpImgLoadEarly.setAttribute('loading', 'eager');
    lcpImgLoadEarly.setAttribute('fetchpriority', 'high');
    return lcpImgLoadEarly;
  };

  const isMobile = window.matchMedia('(max-width: 767px)').matches;
  // ['hero-banner', 'hero-banner-car-detail']
  LCP_BLOCKS.forEach((selector) => {
    const lcpCarDetailBlock = main.querySelectorAll(`.${selector} picture`);
    if (lcpCarDetailBlock.length) {
      if (isMobile) {
        // mobile image
        imgLoader(lcpCarDetailBlock?.[1]?.querySelector('img')?.src);
      } else {
        // desktop image
        imgLoader(lcpCarDetailBlock?.[0]?.querySelector('source')?.srcset);
      }
    }
  });
}

/**
 * Decorates delivery assets by replacing anchor elements with optimized pictures.
 * @param {HTMLElement} main - The main element containing the anchor elements.
 */
export function decorateDeliveryImages(main) {
  const anchors = Array.from(main.getElementsByTagName('a'));
  siteDomain = getSiteDomain();
  const deliveryUrls = anchors.filter(
    (anchor) => anchor.href.includes(DELIVERY_ASSET_IDENTIFIER) && anchor.href.includes(DELIVERY_IMAGE_IDENTIFIER),
  );
  if (deliveryUrls.length > 0) {
    deliveryUrls.forEach((anchor) => {
      let deliveryUrl = new URL(anchor.href);
      if (!isExternalLink(deliveryUrl) && siteDomain) {
        deliveryUrl = siteDomain + deliveryUrl.pathname + deliveryUrl.search;
      }
      const altText = anchor.title;
      const picture = createOptimizedPictureWithDeliveryUrls(deliveryUrl, altText);
      anchor.replaceWith(picture);
    });

    loadLcpImagesEarly(main);
  }
}

// Function to convert the existing div structure
export function createVideoElement(videoUrl, posterImageUrl, assetName) {
  const videoDiv = document.createElement('div');
  const newAnchor = document.createElement('a');
  newAnchor.href = videoUrl;
  newAnchor.textContent = assetName;
  if (posterImageUrl) {
    const picture = createOptimizedPictureWithDeliveryUrls(posterImageUrl);
    videoDiv.appendChild(picture);
  }
  videoDiv.appendChild(newAnchor);
  return videoDiv;
}

export function decorateDeliveryVideos(main) {
  const anchors = Array.from(main.getElementsByTagName('a'));
  siteDomain = getSiteDomain();
  const urls = anchors.filter(
    (anchor) => anchor.href.includes(DELIVERY_ASSET_IDENTIFIER) && anchor.href.includes(DELIVERY_VIDEO_IDENTIFIER),
  );
  if (urls.length > 0) {
    urls.forEach((anchor) => {
      const url = new URL(anchor.href);
      const videoName = url.searchParams.get('assetname');
      const options = anchor.title;
      const videoMainDiv = anchor.closest('.video');
      const posterUrlAnchor = videoMainDiv?.querySelector('div p:nth-of-type(2) a');
      let videoUrl = '';
      if (!isExternalLink(url) && siteDomain) {
        videoUrl = `${siteDomain}${url.pathname.split('?')[0]}`;
      } else {
        videoUrl = `${url.origin}${url.pathname.split('?')[0]}`;
      }

      let posterImageUrl = '';
      if (posterUrlAnchor && !isExternalLink(posterUrlAnchor.href) && siteDomain) {
        const posterurl = new URL(posterUrlAnchor.href);
        const relativepath = posterurl.pathname + posterurl.search;
        posterImageUrl = `${siteDomain}${relativepath}`;
      } else if (posterUrlAnchor && isExternalLink(posterUrlAnchor.href)) {
        posterImageUrl = posterUrlAnchor.href;
      }
      const video = createVideoElement(videoUrl, posterImageUrl, videoName);
      if (videoMainDiv && options) {
        const videoOptions = options.split(',');
        videoOptions.forEach((option) => {
          const trimmedOption = option.trim();
          if (encodeURI(trimmedOption) !== anchor.href) {
            videoMainDiv.classList.add(trimmedOption);
          }
        });
      }
      anchor.parentElement.replaceWith(video);
    });
  }
}

/**
 * Decorates the main element.
 * @param {Element} main The main element
 */
// eslint-disable-next-line import/prefer-default-export
export function decorateMain(main) {
  // hopefully forward compatible button decoration
  decorateButtons(main);
  decorateIcons(main);
  buildAutoBlocks(main);
  decorateSections(main);
  decorateDeliveryVideos(main);
  decorateDeliveryImages(main);
  decorateBlocks(main);
}

function getMartechDelayParam() {
  const urlParams = new URLSearchParams(window.location.search);
  return urlParams.get(LOAD_MARTECH_PARAM) ?? 'delayed';
}

function ensureRelForBlankLinks() {
  const externalLinks = document.querySelectorAll('a[target="_blank"]');
  externalLinks.forEach((link) => {
    const currentRel = link.getAttribute('rel') || '';
    const relSet = new Set(currentRel.split(' ').filter(Boolean));
    relSet.add('noopener');
    relSet.add('noreferrer');
    link.setAttribute('rel', Array.from(relSet).join(' '));
  });
}
/**
 * Loads everything needed to get to LCP.
 * @param {Element} doc The container element
 */
async function loadEager(doc) {
  document.documentElement.lang = 'en';
  decorateTemplateAndTheme();
  const main = doc.querySelector('main');
  if (main) {
    decorateMain(main);
    document.body.classList.add('appear');
    martechLoadedPromise.then(setDataLayer).then(martechEager);
    await waitForLCP(LCP_BLOCKS);
  }

  try {
    /* if desktop (proxy for fast connection) or fonts already loaded, load fonts.css */
    if (window.innerWidth >= 900 || sessionStorage.getItem('fonts-loaded')) {
      loadFonts();
    }
  } catch (e) {
    // do nothing
  }
}

async function loadYY8Header(header) {
  const headerBlock = buildBlock('yy8-header', '');
  if (headerBlock) {
    header.append(headerBlock);
    decorateBlock(headerBlock);
  }
  return loadBlock(headerBlock);
}

async function loadCorpHeader(header) {
  const headerBlock = buildBlock('corp-header', '');
  if (headerBlock) {
    header.append(headerBlock);
    decorateBlock(headerBlock);
  }
  return loadBlock(headerBlock);
}

async function loadCorpFooter(footer) {
  const footerBlock = buildBlock('corp-footer', '');
  if (footerBlock) {
    footer.append(footerBlock);
    decorateBlock(footerBlock);
  }
  return loadBlock(footerBlock);
}

/**
 * Loads everything that doesn't need to be delayed.
 * @param {Element} doc The container element
 */
async function loadLazy(doc) {
  setTimeout(() => {
    document.dispatchEvent(new Event('lazy-phase'));
    Window.LAZY_PHASE = true;
  }, 150);
  const main = doc.querySelector('main');
  if (!main) return; // Add null check for main element
  updateSectionsStatus(main);
  document.documentElement.classList.add('no-scroll');
  if (getMetadata('header-variation') === 'yy8') {
    loadYY8Header(doc.querySelector('header'));
  } else if (getMetadata('header-variation') === 'corporate') {
    loadCorpHeader(doc.querySelector('header'));
  } else {
    loadHeader(doc.querySelector('header'));
  }
  await loadBlocks(main);

  const { hash } = window.location;
  const element = hash ? doc.getElementById(hash.substring(1)) : false;
  if (hash && element) element.scrollIntoView();

  if (getMetadata('header-variation') === 'corporate') {
    loadCorpFooter(doc.querySelector('footer'));
  } else {
    loadFooter(doc.querySelector('footer'));
  }

  if (!authUtils.isAuthPage()) {
    try {
      await authUtils.handleRedirect();
    } catch (error) {}
  }
  loadCSS(`${window.hlx.codeBasePath}/styles/lazy-styles.css`);
  loadFonts();

  setDataLayer();
  await martechLazy();
  document.querySelector('.header-wrapper')?.classList?.add('sticky');
  const overlayDiv = document.createElement('div');
  overlayDiv.classList.add('menu__bgoverlay');
  document.body.insertBefore(overlayDiv, document.body.firstChild);
  ensureRelForBlankLinks();
  const observer = new MutationObserver(() => {
    ensureRelForBlankLinks();
  });

  observer.observe(document.body, {
    childList: true,
    subtree: true,
  });
  seoUtils.getJSON();
}
// Function to toggle URLs for all <picture> elements based on checkbox state
async function toggleImageUrls(checkbox) {
  const pictureContainers = document.querySelectorAll('img');
  let img = null;
  let sources = null;
  pictureContainers.forEach((pictureContainer) => {
    if (pictureContainer.parentElement && pictureContainer.parentElement.tagName.toLowerCase() === 'picture') {
      sources = pictureContainer.parentElement.querySelectorAll('source');
    } else {
      sources = null;
    }
    img = pictureContainer;

    if (checkbox.checked) {
      // Add &quality=100 to all image URLs
      sources != null &&
        sources.forEach((source) => {
          if (source.hasAttribute('srcset') && source.getAttribute('srcset').trim() !== '') {
            const url = new URL(source.getAttribute('srcset'), window.location.origin);
            // Append new query parameters
            if (url.href.includes('urn:')) {
              url.searchParams.set('quality', '100');
            } else if (url.href.includes('is/image')) {
              url.searchParams.set('qlt', '100');
            }
            source.setAttribute('srcset', url.toString());
          }
        });

      const imgUrl = new URL(img.getAttribute('src'), window.location.origin);
      // Append new query parameters to <img> src
      if (imgUrl.href.includes('urn:')) {
        imgUrl.searchParams.set('quality', '100');
      } else if (imgUrl.href.includes('is/image')) {
        imgUrl.searchParams.set('qlt', '100');
      }
      img.setAttribute('src', imgUrl.toString());
      // Force the browser to re-render the picture element by replacing it
      const newPicture = pictureContainer.cloneNode(true); // Clone the <picture> element
      pictureContainer.parentNode.replaceChild(newPicture, pictureContainer);
    } else {
      // Remove &quality=100 from all image URLs to revert to original
      sources != null &&
        sources.forEach((source) => {
          if (source.hasAttribute('srcset') && source.getAttribute('srcset').trim() !== '') {
            const url = new URL(source.getAttribute('srcset'));
            // Remove the new query parameters
            url.searchParams.delete('quality');
            url.searchParams.delete('qlt');
            source.setAttribute('srcset', url.toString());
          }
        });

      const imgUrl = new URL(img.getAttribute('src'));
      // Remove the new query parameters from <img> src
      imgUrl.searchParams.delete('quality');
      img.setAttribute('src', imgUrl.toString());
      // Force the browser to re-render the picture element by replacing it
      const newPicture = pictureContainer.cloneNode(true); // Clone the <picture> element
      pictureContainer.parentNode.replaceChild(newPicture, pictureContainer);
    }
  });
}
function sendHDButtonDataLayerEvent(enabled, blockName, componentTitle) {
  const digitalData = {
    event: 'web.webInteraction.linkClicks',
    producedBy: 'EDS',
    // eslint-disable-next-line no-underscore-dangle
    _maruti: {
      pageInfo: {
        language: getMetadata('language') || 'en',
        city:
          utility.getLocalStorage('selected-location')?.cityName ||
          document.querySelector('.location-btn')?.dataset?.cityName ||
          'Delhi',
      },
      userInfo: {
        authenticatedState: window.authenticatedState || 'unauthenticated',
        userAgent: navigator.userAgent,
      },
      identities: {
        hashedphoneSHA256: window.hashedphoneSHA256 || null,
      },
      clickInfo: {
        componentType: 'button',
        componentName: blockName,
        componentTitle: componentTitle,
      },
    },
    web: {
      webPageDetails: {
        URL: window.location.href,
        name: document.title,
        server: window.location.hostname,
        siteSection: getMetadata('sitesection') || '',
      },
      webInteraction: {
        name: enabled ? 'HD On' : 'HD Off',
        type: 'other',
      },
    },
  };
  window.adobeDataLayer.push(digitalData);
}
/**
 * Loads everything that happens a lot later,
 * without impacting the user experience.
 */
function loadDelayed() {
  // eslint-disable-next-line import/no-cycle
  window.setTimeout(() => {
    // run the launch container
    martechDelayed();
    // HD button
    const checkbox = document.querySelector('#toggleCheckbox'); // Checkbox element
    const targetDiv = document.querySelector('#hdToggleWrapper');
    checkbox?.addEventListener('change', (e) => {
      let webName = 'HD On';
      window.hdRenderingEnabled = checkbox.checked;
      document.dispatchEvent(new CustomEvent('hd-button-toggle-event', { detail: { enabled: checkbox.checked } }));
      if (checkbox.checked) {
        targetDiv?.classList.add('checked');
      } else {
        targetDiv?.classList.remove('checked');
        webName = 'HD Off';
      }
      const blockName = e.target?.dataset?.layerComponentName;
      const componentTitle = e.target?.dataset?.layerComponentTitle;
      sendHDButtonDataLayerEvent(checkbox.checked, blockName, componentTitle);
      toggleImageUrls(checkbox);
    });
    // handle focus outline for mouse vs keyboard
    document.addEventListener('keydown', (event) => {
      if (event.key === 'Tab') {
        document.body.classList.remove('mouse-user');
      }
    });
    document.addEventListener('mousedown', () => {
      document.body.classList.add('mouse-user');
    });
    import('./delayed.js');
  }, 3000);
  // load anything that can be postponed to the latest here
  import('./sidekick.js').then(({ initSidekick }) => initSidekick());
}
function removeEmpty(obj) {
  Object.keys(obj).forEach((key) => {
    if (typeof obj[key] === 'object' && obj[key] !== null) {
      removeEmpty(obj[key]);
    }
    if (
      obj[key] === undefined ||
      obj[key] === null ||
      (typeof obj[key] === 'object' && Object.keys(obj[key]).length === 0)
    ) {
      delete obj[key];
    }
  });
}

function createPageLoadDataLayerObject(params) {
  const fbClickID = getCookieValue('_fbc') || null;
  const fbBrowserID = getCookieValue('_fbp') || null;

  const isFramed = window.self !== window.top;

  const result = {
    // event: params.event || undefined,
    producedBy: isFramed ? 'TOI' : 'EDS',
    _maruti: {
      pageInfo: {
        language: params.selectedLanguage || undefined,
        city: params.cityName || undefined,
      },
      userInfo: {
        authenticatedState: params.authenticatedState || undefined,
        userAgent: navigator.userAgent,
      },
      identities: {
        ecid: params.ecid || undefined,
        hashedphoneSHA256: params.hashedphoneSHA256 || undefined,
      },
      carInfo: {
        model: params.model || undefined,
        color: params.color || undefined,
        carType: params.carType || undefined,
      },
      campaign: {
        fbClickID,
        fbBrowserID,
      },
    },
    identityMap:
      authenticatedState === 'authenticated'
        ? {
            Phone_SHA256: [
              {
                id: window.hashedphoneSHA256 || false,
                primary: true,
                authenticatedState: window.authenticatedState || 'unauthenticated',
              },
            ],
          }
        : {},
    web: {
      webPageDetails: {
        URL: params.url || undefined,
        name: params.pageName || undefined,
        server: params.server || undefined,
        siteSection: params.siteSection || undefined,
        isErrorPage: params.isErrorPage || false,
      },
      webReferrer: {
        URL: params.webReferrerURL || undefined,
      },
    },
  };

  removeEmpty(result);
  return result;
}
function getLocalStorage(key) {
  const item = localStorage.getItem(key);
  return item ? JSON.parse(item) : null;
}

function getCookieValue(cookieName) {
  const name = `${cookieName}=`;
  const decodedCookie = decodeURIComponent(document.cookie);
  const cookiesArray = decodedCookie.split(';');

  for (let i = 0; i < cookiesArray.length; i += 1) {
    const cookie = cookiesArray[i].trim();
    if (cookie.indexOf(name) === 0) {
      return cookie.substring(name.length, cookie.length).replace('MCMID|', '');
    }
  }
  return null;
}

async function setDataLayer() {
  const escapeHTML = (unsafeStr) => {
    return unsafeStr
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;')
      .replace(/%/g, '%25')
      .replace(/\//g, '&#x2F;');
  };

  /**
   * Cleans the escaped URL back to its original state.
   * @param {string} escapedURL - The escaped URL to be cleaned.
   * @returns {string} The original URL.
   */
  function cleanEscapedURL(escapedURL) {
    return escapedURL
      .replace(/&lt;/g, '<')
      .replace(/&gt;/g, '>')
      .replace(/&quot;/g, '"')
      .replace(/&#39;/g, "'")
      .replace(/%25/g, '%')
      .replace(/&#x2F;/g, '/');
  }

  // [MK] - this logic is wrong. URL will not contain `corporate` keyword. Setting to `null` for now. Don't make API calls on page loading time.
  // const { corporatepage } = await fetchPlaceholders();
  const corporatepage = null;
  const ecid = getCookieValue('AMCV_BC401D6765FB06150A495FF7@AdobeOrg');
  const { hostname: server, pathname: currentPagePath, href: url } = document.location;
  const pageName = document.title;
  const escapedWebReferrerURL = escapeHTML(document.referrer);
  const webReferrerURL = cleanEscapedURL(escapedWebReferrerURL);
  const cityName = getLocalStorage('selected-location')?.cityName || 'Delhi';
  const selectedLanguage = getMetadata('language') || 'en';
  // const event = 'web.webPageDetails.pageViews';
  let authenticatedState = 'unauthenticated';
  let hashedphoneSHA256 = undefined;
  const profile = await authUtils.getProfile();
  if (profile) {
    authenticatedState = 'authenticated';
    hashedphoneSHA256 = await utility.sha256(profile.number);
    window.hashedphoneSHA256 = hashedphoneSHA256;
  }
  window.authenticatedState = authenticatedState;
  if (hidValue) {
    hashedphoneSHA256 = hidValue;
    window.hashedphoneSHA256 = hidValue;
    window.authenticatedState = 'authenticated';
  }
  const isErrorPage = document.querySelector('main')?.classList?.contains('error') ?? null;
  const modelName = getMetadata('car-model-name');
  let siteSection = '';
  if (url.includes('arena')) {
    siteSection = 'Arena';
  } else if (url.includes('nexa')) {
    siteSection = 'Nexa';
  }

  // [MK] - this logic is wrong. URL will not contain `corporate` keyword.
  if (url.includes(corporatepage)) {
    const data = {
      // event,
      authenticatedState,
      ecid,
      url,
      pageName,
      server,
      siteSection,
      isErrorPage,
      hashedphoneSHA256,
      webReferrerURL,
    };
    window.adobeDataLayer.push(createPageLoadDataLayerObject(data));
  } else if (modelName) {
    const data = {
      // event,
      cityName,
      selectedLanguage,
      authenticatedState,
      ecid,
      url,
      pageName,
      server,
      siteSection,
      isErrorPage,
      model: modelName,
      hashedphoneSHA256,
      webReferrerURL,
    };
    window.adobeDataLayer.push(createPageLoadDataLayerObject(data));
  } else {
    const data = {
      // event,
      cityName,
      selectedLanguage,
      authenticatedState,
      ecid,
      url,
      pageName,
      server,
      siteSection,
      isErrorPage,
      hashedphoneSHA256,
      webReferrerURL,
    };
    window.adobeDataLayer.push(createPageLoadDataLayerObject(data));
  }
}

async function loadPage() {
  if (window.location.href.includes('author')) {
    loadCSS(`${window.hlx.codeBasePath}/styles/aem-styles.css`);
  }
  window.adobeDataLayer = window.adobeDataLayer || [];
  if (authUtils.isAuthPage()) {
    try {
      if (!(await authUtils.handleRedirect())) {
        await authUtils.login();
      } else {
        await authUtils.getToken(true);
      }
    } catch (error) {
      const { authDefaultFallbackRedirect } = await fetchPlaceholders();
      window.location.href = authDefaultFallbackRedirect;
    }
  }
  await loadEager(document);
  await loadLazy(document);
  loadDelayed();
}

export function mergeImagesForArtDirection(img, imgMobile) {
  const removeInstrumentation = (of) => {
    const attributes = [...of.attributes].filter(
      ({ nodeName }) => nodeName.startsWith('data-aue-') || nodeName.startsWith('data-richtext-'),
    );
    if (attributes.length) {
      // eslint-disable-next-line no-restricted-syntax
      for (const { nodeName } of attributes) of.removeAttribute(nodeName);
      // eslint-disable-next-line max-len
      return attributes.reduce((prev, { nodeName, nodeValue }) => ({ ...prev, [nodeName]: nodeValue }), {});
    }
    return null;
  };
  const applyDynamicInstrumentation = () => {
    const dynamicInstrumentation = {};
    // eslint-disable-next-line no-restricted-syntax
    for (const entry of [[img, 'min-width: 600px'], [imgMobile]]) {
      const [element, mediaQuery = ''] = entry;
      const instrumentation = removeInstrumentation(element);
      if (!instrumentation) {
        return;
      }
      dynamicInstrumentation[mediaQuery] = instrumentation;
    }
    imgMobile.dataset.dynamicInstrumentation = JSON.stringify(dynamicInstrumentation);
  };

  if (imgMobile) {
    const pictureMobile = imgMobile.parentElement;
    // merge the imgMobile into the img:
    // the sources have min-width media queries for desktop,
    // we select the one without a media query which is for mobile
    const pictureMobileMobileSource = pictureMobile.querySelector('source:not([media])');
    if (pictureMobileMobileSource) {
      const pcitureMobileSource = img.parentElement.querySelector('source:not([media])');
      if (pcitureMobileSource) pcitureMobileSource.replaceWith(pictureMobileMobileSource);
      else img.before(pictureMobileMobileSource);
    } else {
      // create a source if there are non (authoring specific case)
      const source = document.createElement('source');
      source.srcset = img.src;
      source.media = '(min-width: 600px)';
      img.before(source);
    }
    // the fallback image should also be the mobile one itself is also mobile so replace it
    img.replaceWith(imgMobile);
    // remove picture mobile
    const p = pictureMobile.parentElement;
    pictureMobile.remove();
    if (p.children.length === 0 && !p.textContent.trim()) p.remove();
    // the instrumentation depends on the viewport size, so we remove it
    applyDynamicInstrumentation();
  }
}

loadPage();

function pageScrollAnalytics() {
  function initScrollingDetails() {
    window.scrolling = {
      to25: false,
      to50: false,
      to75: false,
      to100: false,
    };
  }

  async function updateScrollingDetails() {
    const cityName = getLocalStorage('selected-location')?.cityName || 'Delhi';
    const selectedLanguage = getMetadata('language') || 'en';
    const fbClickID = getCookieValue('_fbc') || null;
    const fbBrowserID = getCookieValue('_fbp') || null;

    // const event = 'web.webPageDetails.pageViews';
    let authenticatedState = 'unauthenticated';
    let hashedphoneSHA256 = undefined;
    const profile = await authUtils.getProfile();
    if (profile) {
      authenticatedState = 'authenticated';
      hashedphoneSHA256 = await utility.sha256(profile.number);
      window.hashedphoneSHA256 = hashedphoneSHA256;
    }
    if (hidValue) {
      authenticatedState = 'authenticated';
      hashedphoneSHA256 = hidValue;
      window.hashedphoneSHA256 = hidValue;
    }
    const { href: url } = document.location;
    let siteSection = '';

    if (url.includes('arena')) {
      siteSection = 'Arena';
    } else if (url.includes('nexa')) {
      siteSection = 'Nexa';
    }
    try {
      var scrollTop = window.scrollY;
      var docHeight = document.body.offsetHeight;
      var winHeight = window.innerHeight;
      var scrollPercent = scrollTop / (docHeight - winHeight);
      var scrollPercentRounded = Math.round(scrollPercent * 100);
      var updated = [];
      if (scrollPercentRounded <= 25 && !scrolling.to25) {
        updated.push(25);
        scrolling.to25 = true;
      }
      if (scrollPercentRounded > 25 && scrollPercentRounded <= 50 && !scrolling.to50) {
        updated.push(50);
        scrolling.to50 = true;
      }
      if (scrollPercentRounded > 50 && scrollPercentRounded <= 75 && !scrolling.to75) {
        updated.push(75);
        scrolling.to75 = true;
      }
      if (scrollPercentRounded > 75 && scrollPercentRounded <= 100 && !scrolling.to100) {
        updated.push(100);
        scrolling.to100 = true;
      }

      // we only want to send an anlytics call if scrolling has been updated
      if (updated.length > 0) {
        window.adobeDataLayer.push({
          event: 'web.webInteraction.pageScroll',
          producedBy: 'EDS',
          _maruti: {
            clickInfo: undefined,
            pageInfo: {
              language: selectedLanguage,
              city: cityName,
              scrollPercentage: updated[updated.length - 1].toString(),
            },
            userInfo: {
              authenticatedState,
            },
            identities: {
              hashedphoneSHA256,
            },
            clickInfo: {
              componentType: null,
              componentName: null,
              componentTitle: null,
            },
            campaign: {
              fbClickID,
              fbBrowserID,
            },
          },
          web: {
            webPageDetails: {
              URL: window.location.href,
              name: document.title,
              server: location.hostname,
              siteSection,
              isErrorPage: document.querySelector('main')?.classList?.contains('error') || null,
            },
            webInteraction: {
              name: null,
              type: null,
            },
          },
        });
      }
    } catch (e) {
      console.log('Failed while updating scolling errors', e);
    }
  }
  try {
    initScrollingDetails();
    window.addEventListener('scroll', updateScrollingDetails);
  } catch (e) {
    console.log('Failed while tracking scrolling', e);
  }
}

/**
 * @param {*} pageScrollWhitelist The whitelist of blocks to observe
 * if page-scroll-whitelist is present in metadata, then only this script will be executed
 */
const pageScrollWhitelist = getMetadata('page-scroll-whitelist');
if (!pageScrollWhitelist) {
  pageScrollAnalytics();
}
